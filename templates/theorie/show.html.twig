{% extends 'base.html.twig' %}

{% block title %}D√©tails de la th√©orie{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/post/page2.css') }}">
{% endblock %}

{% block body %}
<main class="posts">
    <!-- Container principal pour la th√©orie -->
    <div class="forum-container">
        <div class="user-info">
            {# Affichage de l'auteur si disponible, sinon un libell√© par d√©faut #}
            <h3>{{ theorie.user.username|default('Auteur inconnu') }}</h3>
            <img src="{{ asset('images/postspage2/Mikasa_avec_les_cheveux_longs.webp') }}" alt="Avatar">
            <p>Inscrit depuis Ao√ªt 2024</p>
        </div>
        <div class="post-content">
            <div class="post-header">
                <span>{{ theorie.titre }}</span>
            </div>
            <div class="daterepondre">
                <span class="datepubli">le: {{ theorie.datePublication|date('d M Y, H:i:s') }}</span>
                <span class="report">Report</span>
            </div>
            <div class="post-body">
                <p>{{ theorie.contenu }}</p>
                <div class="media">
                    <h3>M√©dia</h3>
                    {% if media_base64 %}
                        <div>
                            <p>Type: {{ theorie.mediaType }}</p>
                            {% if theorie.mediaType starts with 'image' %}
                                <img src="data:{{ theorie.mediaType }};base64,{{ media_base64 }}" alt="M√©dia associ√©" class="img-fluid" />
                            {% elseif theorie.mediaType starts with 'video' %}
                                <video controls class="w-100">
                                    <source src="data:{{ theorie.mediaType }};base64,{{ media_base64 }}">
                                    Votre navigateur ne supporte pas la lecture vid√©o.
                                </video>
                            {% elseif theorie.mediaType starts with 'audio' %}
                                <audio controls>
                                    <source src="data:{{ theorie.mediaType }};base64,{{ media_base64 }}">
                                    Votre navigateur ne supporte pas la lecture audio.
                                </audio>
                            {% endif %}
                        </div>
                    {% else %}
                        <p>Aucun m√©dia associ√©</p>
                    {% endif %}
                </div>
            </div>
            <div class="footerdate">
                <span class="datemodif">¬´ Publi√© le: {{ theorie.datePublication|date('d M Y, H:i:s') }} ¬ª</span>
            </div>
            <div class="likeanswer">
                <form method="post" action="{{ path('like_toggle') }}" class="like-form" data-entity-id="{{ theorie.id }}" data-entity-type="theorie">
                    <button type="submit" class="like-btn">
                        <span class="like-icon">
                            {% if isLiked %}
                                ‚ù§Ô∏è
                            {% else %}
                                ü§ç
                            {% endif %}
                        </span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Container pour les commentaires -->
    <div class="forum-container">
        <div class="post-content" style="width:100%">
            <h2>Commentaires</h2>
            <ul class="list-group">
                {% for commentaire in theorie.commentaires %}
                    <li class="list-group-item">
                        <strong>{{ commentaire.user.username }}</strong> le {{ commentaire.datePublication|date('d/m/Y H:i') }} :
                        <p>{{ commentaire.contenu }}</p>

                        <!-- Bouton Like pour les commentaires -->
                        <div>
                            <form method="post" action="{{ path('like_toggle') }}" class="like-form" data-entity-id="{{ commentaire.id }}" data-entity-type="commentaire">
                                <button type="submit" class="like-btn">
                                    <span class="like-icon">
                                        {% if commentaireLikes[commentaire.id] is defined and commentaireLikes[commentaire.id] %}
                                            ‚ù§Ô∏è
                                        {% else %}
                                            ü§ç
                                        {% endif %}
                                    </span>
                                </button>
                            </form>
                        </div>

                        {% if app.user and app.user.id == commentaire.user.id %}
                            <div class="mt-2">
                                <a href="{{ path('commentaire_edit', {id: commentaire.id}) }}" class="btn btn-primary btn-sm">Modifier</a>
                                <form method="post" action="{{ path('commentaire_delete', {id: commentaire.id}) }}" style="display: inline;" onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer ce commentaire ?');">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ commentaire.id) }}">
                                    <button type="submit" class="btn btn-danger btn-sm">Supprimer</button>
                                </form>
                            </div>
                        {% endif %}

                        <form method="post" action="{{ path('commentaire_report', {id: commentaire.id}) }}" style="display: inline;">
                            <input type="hidden" name="_token" value="{{ csrf_token('report' ~ commentaire.id) }}">
                            <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Voulez-vous signaler ce commentaire ?');">
                                Signaler
                            </button>
                        </form>
                    </li>
                {% else %}
                    <li class="list-group-item text-center">Aucun commentaire pour cette th√©orie.</li>
                {% endfor %}
            </ul>

            {% if is_granted('IS_AUTHENTICATED_FULLY') %}
                <div class="mt-4">
                    <h3>Ajouter un commentaire</h3>
                    <form method="post" action="{{ path('commentaire_new', {entity: 'theorie', id: theorie.id}) }}">
                        <div class="form-group">
                            <label for="contenu">Votre commentaire</label>
                            <textarea id="contenu" name="contenu" class="form-control" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success mt-2">Publier</button>
                    </form>
                </div>
            {% else %}
                <p class="mt-3">Veuillez <a href="{{ path('app_login') }}">vous connecter</a> pour ajouter un commentaire.</p>
            {% endif %}
        </div>
    </div>
</main>

<script>
    document.querySelectorAll('.like-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            formData.append('id', this.dataset.entityId);
            formData.append('type', this.dataset.entityType);

            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const likeIcon = this.querySelector('.like-icon');
                if (data.isLiked) {
                    likeIcon.innerHTML = '‚ù§Ô∏è';
                } else {
                    likeIcon.innerHTML = 'ü§ç';
                }
            })
            .catch(error => console.error('Erreur:', error));
        });
    });
</script>
{% endblock %}
